<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Falklands V2 — Web Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{
      --fg:#111; --muted:#666; --line:#eaeaea; --chip:#f6f6f6;
      --ok-bg:#dff5e1; --ok-fg:#186a3b;
      --out-bg:#fde2e0; --out-fg:#92332a;
      --na-bg:#eee; --na-fg:#555;
      --hostile:#ffefef; --hostile-fg:#a61313;
      --friendly:#eef4ff; --friendly-fg:#224b9b;
      --neutral:#f1f1f1; --neutral-fg:#666;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:16px;color:var(--fg)}
    h1{margin:0 0 10px}
    .row{display:flex;gap:14px;flex-wrap:wrap}
    .card{border:1px solid var(--line);border-radius:12px;padding:12px 14px;box-shadow:0 1px 3px rgba(0,0,0,.05);background:#fff}
    .card h2{margin:0 0 10px;font-size:16px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;background:var(--chip)}
    .pill.hostile{background:var(--hostile);color:var(--hostile-fg);border:1px solid #f2c5c5}
    .pill.friendly{background:var(--friendly);color:var(--friendly-fg);border:1px solid #c9d7ff}
    .pill.neutral{background:var(--neutral);color:var(--neutral-fg);border:1px solid #ddd}
    .badge{padding:2px 8px;border-radius:999px;font-size:12px;display:inline-block}
    .badge.ready{background:var(--ok-bg);color:var(--ok-fg);border:1px solid #c2e6c6}
    .badge.out{background:var(--out-bg);color:var(--out-fg);border:1px solid #f3b1ab}
    .badge.na{background:var(--na-bg);color:var(--na-fg);border:1px solid #ddd}
    table{border-collapse:collapse;width:100%}
    th,td{border-bottom:1px solid var(--line);text-align:left;padding:6px 8px}
    th{font-weight:600}
    input[type=number],input[type=text]{width:86px;padding:4px 6px}
    button{padding:4px 10px;border:1px solid #ccc;border-radius:8px;background:#fafafa;cursor:pointer}
    button:disabled{opacity:.55;cursor:not-allowed}
    .tiny{font-size:12px;color:var(--muted)}
    #debug{margin-top:10px;color:#a13;font-size:12px}
  </style>
</head>
<body>
  <h1>Falklands V2 — Web Dashboard</h1>

  <!-- HUD row -->
  <div class="row">
    <div class="card" style="flex:2 1 520px;">
      <h2>HUD</h2>
      <div class="mono" id="hud_line">loading…</div>
      <div class="tiny" id="hud_escorts">Escorts: —</div>
    </div>

    <div class="card" style="flex:1 1 360px;">
      <h2>Own Ship</h2>
      <div>Cell: <span id="ship_cell" class="pill">—</span></div>
      <div>Course: <span id="ship_course" class="mono">—</span>°</div>
      <div>Speed: <span id="ship_speed" class="mono">—</span> kts</div>
      <div style="margin-top:8px">
        <label>Set course <input id="set_course" type="number" min="0" max="359" step="1"></label>
        <label style="margin-left:8px;">Set speed <input id="set_speed" type="number" min="0" step="1"></label>
        <button onclick="helm()">Apply</button>
        <button onclick="resetGame()">Reset</button>
        <button id="pauseBtn" onclick="togglePause()">Pause</button>
      </div>
    </div>
  </div>

  <!-- Primary Target + Radar -->
  <div class="row" style="margin-top:14px;">
    <div class="card" style="flex:2 1 520px;">
      <h2>Primary Target</h2>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px;">
        <label>Target ID <input id="lock_id" type="number" min="1" step="1" class="mono" style="width:90px"></label>
        <button onclick="lock()">Lock</button>
        <button onclick="unlock()">Unlock</button>
      </div>
      <div class="mono tiny" id="primary_lock_line">LOCKED: —</div>
      <div style="margin-top:8px;overflow-x:auto">
        <table>
          <thead><tr><th>CELL</th><th>TYPE</th><th>NAME</th><th>RANGE</th><th>CRS</th><th>SPD</th><th>ID</th></tr></thead>
          <tbody id="primary_table_body"><tr><td colspan="7">No hostile contacts.</td></tr></tbody>
        </table>
      </div>
    </div>

    <div class="card" style="flex:1 1 360px;">
      <h2>Radar</h2>
      <div class="mono tiny" id="radar_line">loading…</div>
      <div style="margin-top:8px;"><button onclick="scan()">Scan now</button></div>
    </div>
  </div>

  <!-- Weapons -->
  <div class="card" style="margin-top:14px;">
    <h2>Weapons</h2>
    <div class="mono tiny" id="weapons_ship">—</div>
    <div style="margin-top:8px;overflow-x:auto">
      <table>
        <thead>
          <tr><th>Weapon</th><th>Ammo</th><th>Range</th><th>Status</th><th>Arming</th><th>Action</th></tr>
        </thead>
        <tbody id="weapons_tbl"><tr><td colspan="6">loading…</td></tr></tbody>
      </table>
    </div>
    <div class="tiny mono" style="margin-top:6px;">Arm first (5s), then Fire. Test mode ignores lock/range but still requires arming.</div>
  </div>

  <!-- Hermes CAP -->
  <div class="card" style="margin-top:14px;">
    <h2>Hermes CAP</h2>
    <div class="mono tiny" id="cap_head">loading…</div>
    <div style="margin:6px 0;">
      <button onclick="capRequest()">Request CAP to locked</button>
      <button onclick="capRefresh()">Refresh</button>
      <label style="margin-left:8px"><input id="cap_test_sound" type="checkbox"> sound on</label>
    </div>
    <div style="overflow-x:auto">
      <table>
        <thead><tr><th>#</th><th>Target cell</th><th>Status</th><th>Notes</th></tr></thead>
        <tbody id="cap_table"><tr><td colspan="4">—</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Nearest Contacts (ALL) -->
  <div class="card" style="margin-top:14px;">
    <h2>Nearest Contacts (top 10)</h2>
    <div style="overflow-x:auto">
      <table>
        <thead><tr><th>CELL</th><th>TYPE</th><th>NAME</th><th>RANGE</th><th>CRS</th><th>SPD</th><th>ID</th></tr></thead>
        <tbody id="contacts_body"><tr><td colspan="7">loading…</td></tr></tbody>
      </table>
    </div>
  </div>

  <div id="debug" class="mono"></div>

<script defer>
const $ = id => document.getElementById(id);
const fmt = n => (typeof n === 'number' && isFinite(n)) ? n.toFixed(2) : (n ?? '—');
const safe = f => { try{ f(); } catch(e){ const d=$('debug'); d.textContent = String(e); console.error(e); } };

async function load() {
  let j=null;
  try {
    const r = await fetch('/api/status', {cache:'no-store'});
    j = await r.json();
  } catch(e){
    $('debug').textContent = 'Failed to fetch /api/status';
    return;
  }

  // HUD + escort line
  safe(()=>{ $('hud_line').textContent = j.hud ?? '—'; });
  safe(()=>{ $('ship_cell').textContent = j.ship?.cell ?? '—'; });
  safe(()=>{ $('ship_course').textContent = j.ship?.course_deg ?? '—'; });
  safe(()=>{ $('ship_speed').textContent = j.ship?.speed_kts ?? '—'; });
  safe(()=>{ $('pauseBtn').textContent = j.paused ? 'Resume' : 'Pause'; });
  safe(()=>{
    const esc = (j.hud_escorts || j.escorts || j.convoy_text || '').trim();
    $('hud_escorts').textContent = esc ? esc : 'Escorts: —';
  });

  // Radar
  safe(()=>{ $('radar_line').textContent = (j.radar && j.radar.status_line) ? j.radar.status_line : '—'; });

  // Locked line
  safe(()=>{
    const lk = j.radar?.locked_contact || null;
    $('primary_lock_line').textContent = lk
      ? `LOCKED: #${lk.id} ${lk.name} ${lk.type} ${lk.allegiance} at ${lk.cell}, ${fmt(lk.range_nm)} nm`
      : 'LOCKED: —';
  });

  // Primary = hostiles only
  safe(()=>{
    const ptb = $('primary_table_body'); ptb.innerHTML='';
    const all = Array.isArray(j.contacts) ? j.contacts : [];
    const hostiles = all.filter(c => (c.allegiance||'').toLowerCase()==='hostile')
                        .sort((a,b)=> (a.range_nm??1e9) - (b.range_nm??1e9))
                        .slice(0,5);
    if (!hostiles.length){ ptb.innerHTML='<tr><td colspan="7">No hostile contacts.</td></tr>'; return; }
    for (const c of hostiles){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="mono">${c.cell??'—'}</td>
        <td>${c.type??'—'}</td>
        <td>${c.name??'—'} ${pillFor(c.allegiance)}</td>
        <td class="mono">${fmt(c.range_nm)} nm</td>
        <td class="mono">${c.course_deg??'—'}°</td>
        <td class="mono">${c.speed_kts??'—'}</td>
        <td class="mono">#${String(c.id??'').padStart(2,'0')}</td>`;
      ptb.appendChild(tr);
    }
  });

  // Weapons
  safe(()=> renderWeapons(j));

  // CAP
  safe(()=> renderCAP(j));

  // All contacts
  safe(()=>{
    const tb = $('contacts_body'); tb.innerHTML='';
    const list = Array.isArray(j.contacts) ? j.contacts : [];
    if (!list.length){ tb.innerHTML='<tr><td colspan="7">No contacts.</td></tr>'; return; }
    for (const c of list){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="mono">${c.cell??'—'}</td>
        <td>${c.type??'—'}</td>
        <td>${c.name??'—'} ${pillFor(c.allegiance)}</td>
        <td class="mono">${fmt(c.range_nm)} nm</td>
        <td class="mono">${c.course_deg??'—'}°</td>
        <td class="mono">${c.speed_kts??'—'}</td>
        <td class="mono">#${String(c.id??'').padStart(2,'0')}</td>`;
      tb.appendChild(tr);
    }
  });
}

function pillFor(a){
  const t = String(a||'').toLowerCase();
  if (t==='hostile') return '<span class="pill hostile">Hostile</span>';
  if (t==='friendly') return '<span class="pill friendly">Friendly</span>';
  return '<span class="pill neutral">Neutral</span>';
}

function statusBadge(r){
  if (r.ready === true)  return '<span class="badge ready">READY</span>';
  if (r.ready === false) return '<span class="badge out">OUT</span>';
  return '<span class="badge na">N/A</span>';
}

function renderWeapons(j){
  const tb = $('weapons_tbl'); tb.innerHTML='';
  const W = j.weapons || {};
  // accept either new rows[] or legacy table[]
  const rows = Array.isArray(W.rows) ? W.rows :
               Array.isArray(W.table) ? W.table.map(w=>({
                 key:w.key||w.name, name:w.name, ammo_text:w.ammo, range_text:w.range,
                 ready:(w.ready===true || w.status==='READY'),
                 reason:w.reason||''
               })) : [];
  if (!rows.length){ tb.innerHTML='<tr><td colspan="6">No weapons data.</td></tr>'; return; }
  for (const r of rows){
    const key = r.key || r.name || '';
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.name||r.key||'—'}</td>
      <td class="mono">${r.ammo_text||r.ammo||'—'}</td>
      <td class="mono">${r.range_text||r.range||'—'}</td>
      <td>${statusBadge(r)} <span class="tiny mono">${r.reason||''}</span></td>
      <td id="arm_${cssSafe(key)}" class="mono tiny">${r.armed ? 'Armed' : 'Safe'}</td>
      <td>
        <button ${!key?'disabled':''} onclick="arm('${jsSafe(key)}')">Arm</button>
        <button ${!key?'disabled':''} onclick="fire('${jsSafe(key)}','fire')">Fire</button>
        <button ${!key?'disabled':''} onclick="fire('${jsSafe(key)}','test')">Test</button>
      </td>`;
    tb.appendChild(tr);
  }
}
function cssSafe(s){ return String(s).replace(/[^a-zA-Z0-9_-]/g,'_'); }
function jsSafe(s){ return String(s).replace(/\\/g,'\\\\').replace(/'/g,"\\'"); }

// controls
async function scan(){ await fetch('/api/scan',{method:'POST'}); await load(); }
async function unlock(){ await fetch('/api/unlock',{method:'POST'}); await load(); }
async function lock(){
  const id = parseInt($('lock_id').value); if (!id) return;
  await fetch('/api/lock',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})});
  await load();
}
async function helm(){
  const c=$('set_course').value, s=$('set_speed').value;
  const p={}; if(c!=='') p.course_deg=parseFloat(c); if(s!=='') p.speed_kts=parseFloat(s);
  if(!Object.keys(p).length) return;
  await fetch('/api/helm',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(p)});
  await load();
}
async function resetGame(){ if(!confirm('Reset game to fresh state?')) return; await fetch('/api/reset',{method:'POST'}); await load(); }
async function togglePause(){ const r=await fetch('/api/pause',{method:'POST'}); const j=await r.json(); $('pauseBtn').textContent=j.paused?'Resume':'Pause'; }

// weapon actions
async function arm(key){
  try{
    await fetch('/api/arm',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({weapon:key})});
  }catch(e){ $('debug').textContent='Arm failed'; }
}
async function fire(key,mode){
  try{
    await fetch('/api/fire',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({weapon:key,mode})});
  }catch(e){ $('debug').textContent='Fire failed'; }
}

// CAP
async function capRequest(){
  try{
    const r=await fetch('/api/cap/request',{method:'POST'});
    if(!r.ok){ $('debug').textContent='CAP request rejected (likely no lock or not ready).'; }
    await load();
  }catch(e){ $('debug').textContent='CAP request failed.'; }
}
async function capRefresh(){ await load(); }
function renderCAP(j){
  const hdr = j.cap?.readiness || j.cap_readiness || j.hermes?.readiness || null;
  $('cap_head').textContent = hdr
    ? `${hdr.available ? 'READY' : 'NOT READY'} | pairs ${hdr.ready_pairs} | airframes ${hdr.airframes} | cooldown ${hdr.cooldown_s}s | station ~${hdr.station_radius_nm||5} nm`
    : '—';
  const tb = $('cap_table'); tb.innerHTML='';
  const missions = (j.cap?.missions || j.hermes?.missions || []);
  if(!missions.length){ tb.innerHTML='<tr><td colspan="4">—</td></tr>'; return; }
  for(const m of missions){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="mono">#${m.id}</td>
      <td class="mono">${m.target_cell||'?'}</td>
      <td>${m.status||'?'}</td>
      <td class="mono tiny">${m.timestamps?.eta_onstation ? ('ETA OS: ' + new Date(m.timestamps.eta_onstation*1000).toLocaleTimeString()) : ''}</td>`;
    tb.appendChild(tr);
  }
}

load();
setInterval(load, 1000);
</script>
</body>
</html>