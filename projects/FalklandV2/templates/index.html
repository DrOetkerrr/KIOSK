<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Falklands V2 — Web Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root { --fg:#111; --muted:#666; --line:#e6e6e6; --bg:#fff; font-size:14px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 16px; color: var(--fg); }
    h1 { margin: 0 0 8px; font-size: 18px; }
    h2 { margin: 0 0 8px; font-size: 15px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .card { border: 1px solid var(--line); border-radius: 12px; padding: 10px 12px; box-shadow: 0 1px 3px rgba(0,0,0,.04); background: var(--bg); }
    #contacts table, #weapons table, #cap table, #radar table { border-collapse: collapse; width: 100%; }
    th, td { text-align: left; padding: 6px 6px; border-bottom: 1px solid #f0f0f0; font-variant-numeric: tabular-nums; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .pill { display:inline-block; padding:1px 6px; border-radius:999px; font-size:12px; background:#f2f2f2; }
    .ready { background:#d9f2d9; }
    .notready { background:#f7d9d9; }
    .badge { padding:2px 8px; border-radius:999px; background:#eee; font-size:12px; }
    .muted { color: var(--muted); }
    .btn { padding:4px 8px; border:1px solid #ddd; border-radius:8px; background:#fafafa; cursor:pointer; }
    .btn:hover { background:#f2f2f2; }
    .controls label { display:inline-block; margin-right: 6px; }
    input[type=number] { width: 90px; }
    .al-hostile { background:#ffe2e2; }
    .al-friendly { background:#e2edff; }
    .al-unknown { background:#eeeeee; }
    #audio_pool { position: fixed; left: -9999px; top: -9999px; width: 1px; height: 1px; overflow: hidden; }
  </style>
</head>
<body>
  <h1>Falklands V2 — Web Dashboard</h1>

  <!-- Top row: HUD, Own Ship, Primary Target -->
  <div class="row">
    <div id="hud" class="card" style="flex:1 1 520px;">
      <h2>HUD</h2>
      <div class="mono" id="hud_line">loading…</div>
      <div class="mono" id="hud_escorts" style="margin-top:4px;">Escorts: —</div>

      <!-- audio toggle -->
      <div style="margin-top:6px;">
        <button id="audio_toggle" class="btn" onclick="toggleAudio()">Enable sound</button>
        <span id="audio_status" class="muted" style="margin-left:6px;">(sound is off)</span>
      </div>
    </div>

    <div id="ship" class="card" style="flex:1 1 360px;">
      <h2>Own Ship</h2>
      <div>Cell: <span id="ship_cell" class="pill">—</span></div>
      <div>Course: <span id="ship_course" class="mono">—</span>°</div>
      <div>Speed: <span id="ship_speed" class="mono">—</span> kts</div>
      <div class="controls" style="margin-top:8px;">
        <label>Set course <input type="number" id="set_course" min="0" max="359" step="1"></label>
        <label>Set speed <input type="number" id="set_speed" min="0" step="1"></label>
        <button class="btn" onclick="helm()">Apply</button>
        <button class="btn" style="margin-left:6px;" onclick="resetGame()">Reset</button>
        <button class="btn" style="margin-left:6px;" id="pauseBtn" onclick="togglePause()">Pause</button>
      </div>
    </div>

    <div id="target" class="card" style="flex:1 1 520px;">
      <h2>Primary Target</h2>
      <div class="mono" id="radar_line">Scan to acquire contacts.</div>
      <div style="margin-top:8px;">
        <button class="btn" onclick="scan()">Scan</button>
        <label style="margin-left:6px;">Lock #<input type="number" id="lock_id" min="1" step="1" style="width:80px;"> <button class="btn" onclick="lock()">Lock</button></label>
        <button class="btn" style="margin-left:6px;" onclick="unlock()">Unlock</button>
      </div>
      <div id="locked_target" class="mono" style="margin-top:8px;">(no target)</div>
    </div>
  </div>

  <!-- Radar (hostiles list) -->
  <div id="radar" class="card" style="margin-top:12px;">
    <h2>Radar</h2>
    <table>
      <thead><tr><th>CELL</th><th>TYPE</th><th>NAME</th><th>RANGE</th><th>CRS</th><th>SPD</th><th>ID</th></tr></thead>
      <tbody id="radar_body"><tr><td colspan="7">loading…</td></tr></tbody>
    </table>
  </div>

  <!-- Weapons -->
  <div class="card" id="weapons" style="margin-top:12px;">
    <div style="display:flex; align-items:center; justify-content:space-between;">
      <h2 style="margin:0;">Weapons</h2>
      <label class="mono" style="font-size:13px;">
        <input type="checkbox" id="test_mode"> Test Fire
      </label>
    </div>
    <div style="overflow-x:auto; margin-top:6px;">
      <table>
        <thead><tr><th>Weapon</th><th>Ammo</th><th>Range</th><th>Status</th><th>Arming</th><th>Action</th></tr></thead>
        <tbody id="weapons_table"><tr><td colspan="6">—</td></tr></tbody>
      </table>
    </div>
    <div class="muted mono" style="margin-top:6px;">Arm first (5s), then Fire. Test mode ignores lock/range but still requires arming.</div>
  </div>

  <!-- Hermes CAP -->
  <div id="cap" class="card" style="margin-top:12px;">
    <h2>Hermes CAP</h2>
    <div class="mono" id="cap_line">loading…</div>
    <div style="margin-top:6px;">
      <button class="btn" onclick="capRefresh()">Refresh</button>
      <button class="btn" style="margin-left:6px;" onclick="capRequest()">Request CAP to locked</button>
    </div>
    <div style="margin-top:6px; overflow-x:auto;">
      <table>
        <thead><tr><th>#</th><th>Target cell</th><th>Status</th><th>Notes</th></tr></thead>
        <tbody id="cap_table"><tr><td colspan="4">—</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Nearest contacts (hostiles) -->
  <div id="contacts" class="card" style="margin-top:12px;">
    <h2>Nearest Hostile Contacts (top 10)</h2>
    <table>
      <thead><tr><th>CELL</th><th>TYPE</th><th>NAME</th><th>RANGE</th><th>CRS</th><th>SPD</th><th>ID</th></tr></thead>
      <tbody id="contacts_body"><tr><td colspan="7">loading…</td></tr></tbody>
    </table>
  </div>

  <!-- Hidden audio pool -->
  <div id="audio_pool"></div>

<script>
let AUDIO_ENABLED = false;

// ---------- audio toggle
function readAudioPref(){
  try { AUDIO_ENABLED = (localStorage.getItem('audio_enabled') === '1'); } catch(e){ AUDIO_ENABLED = false; }
  refreshAudioUI();
}
function writeAudioPref(){
  try { localStorage.setItem('audio_enabled', AUDIO_ENABLED ? '1' : '0'); } catch(e){}
  refreshAudioUI();
}
function refreshAudioUI(){
  const btn = document.getElementById('audio_toggle');
  const st = document.getElementById('audio_status');
  if (AUDIO_ENABLED) { btn.textContent = 'Disable sound'; st.textContent = '(sound is on)'; }
  else { btn.textContent = 'Enable sound'; st.textContent = '(sound is off)'; }
}
function toggleAudio(){
  AUDIO_ENABLED = !AUDIO_ENABLED;
  writeAudioPref();
  const pool = document.getElementById('audio_pool');
  if (AUDIO_ENABLED) {
    [...pool.querySelectorAll('audio')].forEach(a => { a.muted=false; a.play().catch(()=>{}); });
  } else {
    [...pool.querySelectorAll('audio')].forEach(a => { try{ a.pause(); }catch(e){} });
  }
}

// ---------- polling
async function load() {
  const r = await fetch('/api/status');
  const j = await r.json();

  // HUD + ship
  document.getElementById('hud_line').textContent = j.hud;
  document.getElementById('ship_cell').textContent = j.ship.cell;
  document.getElementById('ship_course').textContent = j.ship.course_deg;
  document.getElementById('ship_speed').textContent = j.ship.speed_kts;
  document.getElementById('pauseBtn').textContent = j.paused ? 'Resume' : 'Pause';

  // Escorts short line
  const esc = (j.escorts || []);
  if (esc.length === 0) document.getElementById('hud_escorts').textContent = 'Escorts: —';
  else {
    const parts = esc.map(e => `${e.name}=${e.cell} (${e.course_deg.toFixed(0)}°/${e.speed_kts.toFixed(0)}kts)`);
    document.getElementById('hud_escorts').textContent = 'Escorts: ' + parts.join(', ');
  }

  // Primary target
  const lt = j.locked_target;
  if (lt) {
    document.getElementById('radar_line').textContent = `LOCKED: #${lt.id} ${lt.name} ${lt.type} ${lt.allegiance}`;
    document.getElementById('locked_target').textContent =
      `Cell ${lt.cell} | Range ${lt.range_nm.toFixed(2)} nm | CRS ${lt.course_deg}° | SPD ${lt.speed_kts} kts`;
  } else {
    document.getElementById('radar_line').textContent = 'Lock a target (or Scan).';
    document.getElementById('locked_target').textContent = '(no target)';
  }

  // Radar hostiles table
  fillContactsTable('radar_body', j.contacts || []);

  // Weapons
  const wt = document.getElementById('weapons_table');
  wt.innerHTML = '';
  for (const row of (j.weapons.table || [])) {
    const status = row.ready ? '<span class="badge ready">READY</span>' :
                   (row.in_range === false ? '<span class="badge notready">OUT</span>' : '<span class="badge">N/A</span>');
    const armlabel = row.armed ? 'Armed' : (row.arming_s > 0 ? `Arming ${row.arming_s}s` : 'Safe');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${row.name}</td>
      <td class="mono">${row.ammo}</td>
      <td class="mono">${row.range}</td>
      <td>${status}</td>
      <td class="mono">${armlabel}</td>
      <td>
        <button class="btn" onclick="arm('${row.key}')">Arm</button>
        <button class="btn" onclick="fire('${row.key}')">Fire</button>
      </td>`;
    wt.appendChild(tr);
  }

  // CAP
  renderCAP(j.cap || {readiness:{}, missions:[]});

  // Nearest contacts
  fillContactsTable('contacts_body', j.contacts || []);

  // AUDIO
  syncAudio(j.audio || {playing: [], scheduled: [], now: (Date.now()/1000)});
}

function fillContactsTable(tbodyId, list){
  const tb = document.getElementById(tbodyId);
  tb.innerHTML = '';
  if (list.length === 0) {
    tb.innerHTML = '<tr><td colspan="7">No hostile contacts.</td></tr>';
  } else {
    for (const c of list) {
      const pillClass =
        (String(c.allegiance).toLowerCase().startsWith('host')) ? 'al-hostile' :
        (String(c.allegiance).toLowerCase().startsWith('fri')) ? 'al-friendly' : 'al-unknown';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="mono">${c.cell}</td>
        <td>${c.type}</td>
        <td>${c.name} <span class="pill ${pillClass}">${c.allegiance}</span></td>
        <td class="mono">${c.range_nm.toFixed(1)} nm</td>
        <td class="mono">${c.course_deg}°</td>
        <td class="mono">${c.speed_kts}</td>
        <td class="mono">#${String(c.id).padStart(2,'0')}</td>`;
      tb.appendChild(tr);
    }
  }
}

// ---- CAP helpers
async function capRefresh() {
  const r = await fetch('/api/cap/status');
  const j = await r.json();
  renderCAP(j);
}
async function capRequest() {
  const r = await fetch('/api/cap/request', {method:'POST'});
  const j = await r.json();
  if (!j.ok) alert(j.message || j.error || 'CAP request failed');
  await capRefresh();
}
function renderCAP(snap){
  const r = snap.readiness || {};
  const line =
    `${r.available ? 'READY' : 'NOT READY'} | pairs ${r.ready_pairs ?? '—'} | airframes ${r.airframes ?? '—'} | ` +
    `cooldown ${r.cooldown_s ?? 0}s | station ~${r.station_radius_nm ?? 5} nm`;
  document.getElementById('cap_line').textContent = line;

  const tb = document.getElementById('cap_table');
  tb.innerHTML = '';
  const missions = snap.missions || [];
  if (missions.length === 0) {
    tb.innerHTML = '<tr><td colspan="4">—</td></tr>';
  } else {
    for (const m of missions) {
      const tr = document.createElement('tr');
      const notes = (() => {
        const ts = m.timestamps || {};
        if (m.status === 'airborne') return `en route ETA OS: ${fmtTime(ts.eta_onstation)}`;
        if (m.status === 'onstation') return `ETD RTB: ${fmtTime(ts.etd_rtb)}`;
        if (m.status === 'rtb') return `ETA recovery: ${fmtTime(ts.eta_recovery)}`;
        if (m.status === 'recovering') return `ready again: ${fmtTime(ts.ready_again)}`;
        return '';
      })();
      tr.innerHTML = `<td class="mono">#${m.id}</td><td class="mono">${m.target_cell}</td><td>${m.status}</td><td class="mono">${notes}</td>`;
      tb.appendChild(tr);
    }
  }
}
function fmtTime(ts){ if(!ts) return '—'; const d=new Date(ts*1000); return d.toLocaleTimeString(); }

// ---- commands
async function scan() { await fetch('/api/scan', {method:'POST'}); await load(); }
async function unlock() { await fetch('/api/unlock', {method:'POST'}); await load(); }
async function lock() {
  const id = parseInt(document.getElementById('lock_id').value);
  if (!id) return;
  await fetch('/api/lock', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id})});
  await load();
}
async function helm() {
  const c = document.getElementById('set_course').value;
  const s = document.getElementById('set_speed').value;
  const payload = {};
  if (c !== '') payload.course_deg = parseFloat(c);
  if (s !== '') payload.speed_kts = parseFloat(s);
  if (Object.keys(payload).length === 0) return;
  await fetch('/api/helm', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  await load();
}
async function resetGame() {
  const ok = confirm('Reset game to fresh state? Contacts will be cleared.');
  if (!ok) return;
  const r = await fetch('/api/reset', {method:'POST'});
  const j = await r.json();
  if (!j.ok) { alert('Reset failed: ' + (j.error || 'unknown error')); }
  await load();
}
async function togglePause() {
  const r = await fetch('/api/pause', {method:'POST'});
  const j = await r.json();
  document.getElementById('pauseBtn').textContent = j.paused ? 'Resume' : 'Pause';
}

// ---- Weapons actions
async function arm(key) {
  const r = await fetch('/api/arm', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({weapon:key})});
  const j = await r.json();
  if (!j.ok) alert('Arm failed: ' + (j.error || 'unknown error'));
  await load();
}
function getTestMode(){ return !!document.getElementById('test_mode').checked; }
async function fire(key) {
  const mode = getTestMode() ? 'test' : 'fire';
  const r = await fetch('/api/fire', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({weapon:key, mode})});
  const j = await r.json();
  if (!j.ok) alert('Fire failed: ' + (j.error || 'unknown error'));
  await load();
}

// ---- Audio sync
function makeKey(p){ return `${p.sound_id}::${p.started_at || p.start_at || Math.random()}`; }
function syncAudio(audioSnap){
  const pool = document.getElementById('audio_pool');
  const active = (audioSnap.playing || []).map(p => ({...p, _key: makeKey(p)}));

  if (!AUDIO_ENABLED) {
    [...pool.querySelectorAll('audio')].forEach(a => { try{ a.pause(); }catch(e){} a.remove(); });
    return;
  }

  const existing = {};
  [...pool.querySelectorAll('audio')].forEach(a => { existing[a.dataset.key] = a; });

  for (const p of active) {
    let el = existing[p._key];
    if (!el) {
      el = document.createElement('audio');
      el.dataset.key = p._key;
      el.src = `/sounds/${p.file}`;
      el.loop = !!p.loop;
      el.volume = Math.max(0, Math.min(1, p.volume || 0.8));
      pool.appendChild(el);
      el.muted = false;
      el.play().catch(()=>{});
    } else {
      el.loop = !!p.loop;
      el.volume = Math.max(0, Math.min(1, p.volume || 0.8));
      if (el.paused) el.play().catch(()=>{});
    }
  }

  const activeKeys = new Set(active.map(p => p._key));
  [...pool.querySelectorAll('audio')].forEach(a => {
    if (!activeKeys.has(a.dataset.key)) { try{ a.pause(); }catch(e){} a.remove(); }
  });
}

// boot
(function(){ try { AUDIO_ENABLED = (localStorage.getItem('audio_enabled') === '1'); } catch(e){} refreshAudioUI(); })();
load();
setInterval(load, 1000);
</script>
</body>
</html>